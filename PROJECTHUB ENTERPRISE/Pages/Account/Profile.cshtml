@page
@model PROJECTHUB_ENTERPRISE.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "My Profile";
}
<link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
<div class="container-fluid py-4">
    <!-- Page Header -->
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-2 gradient-text">My Profile</h1>
            <p class="text-muted mb-0">Manage your account information and settings</p>
        </div>

        <a asp-page="/Dashboard/Index" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </header>

    <!-- Profile Card -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <article class="card border-0 shadow-lg overflow-hidden animate-fadeInUp position-relative">
                <!-- Cover -->
                <div class="profile-cover"></div>

                <!-- Avatar -->
                <div class="avatar-upload-container position-absolute" style="top: 100px; left: 2rem;">
                    <img id="mainAvatar"
                         class="profile-avatar"
                         loading="lazy"
                         src="@(string.IsNullOrEmpty(Model.CurrentUser?.AvatarUrl)
                                                             ? "/images/avatar-default.png"
                                                             : Model.CurrentUser.AvatarUrl)"
                         alt="Profile Avatar" />
                </div>

                <!-- Content -->
                <div class="card-body profile-card-body">
                    <div class="row">
                        <!-- Left -->
                        <section class="col-lg-8">
                            <h2 class="profile-name mb-2">
                                @(string.IsNullOrWhiteSpace(Model.CurrentUser?.FullName)
                                                                ? Model.CurrentUser?.Username
                                                                : Model.CurrentUser!.FullName)
                            </h2>

                            <div class="profile-title mb-3">
                                @if (!string.IsNullOrEmpty(Model.CurrentUser?.JobTitle))
                                {
                                    <span>@Model.CurrentUser.JobTitle</span>
                                }
                                @if (!string.IsNullOrEmpty(Model.CurrentUser?.Department))
                                {
                                    <span class="mx-2">•</span>
                                    <span>@Model.CurrentUser.Department</span>
                                }
                            </div>

                            <div class="d-flex align-items-center gap-4 mb-4 flex-wrap">
                                <!-- Email (FIX JS) -->
                                <div class="profile-email">
                                    <i class="bi bi-envelope profile-icon"></i>
                                    <span>@Model.CurrentUser?.Email</span>
                                </div>

                                <!-- Status -->
                                <div>
                                    @if (Model.CurrentUser?.IsActive == true)
                                    {
                                        <span class="badge-active">
                                            <i class="bi bi-check-circle"></i>Active
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge-inactive">
                                            <i class="bi bi-x-circle"></i>Inactive
                                        </span>
                                    }
                                </div>
                            </div>
                        </section>

                        <!-- Right -->
                        <aside class="col-lg-4 text-lg-end">
                            @if (Model.CurrentUser?.CreatedAt != null)
                            {
                                <small class="text-muted d-block">Member Since</small>
                                <strong>@Model.CurrentUser.CreatedAt.ToString("MMM dd, yyyy")</strong>
                            }
                        </aside>
                    </div>

                    <hr class="my-4">

                    <!-- Detail Cards -->
                    <section class="row g-4">
                        <div class="col-md-6">
                            <div class="profile-detail-card">
                                <div class="profile-detail-label">
                                    <i class="bi bi-person profile-icon"></i> Username
                                </div>
                                <div class="profile-detail-value">
                                    @Model.CurrentUser?.Username
                                </div>
                            </div>
                        </div>

                        @if (Model.CurrentUser?.CreatedAt != null)
                        {
                            <div class="col-md-6">
                                <div class="profile-detail-card">
                                    <div class="profile-detail-label">
                                        <i class="bi bi-calendar profile-icon"></i> Account Created
                                    </div>
                                    <div class="profile-detail-value">
                                        @Model.CurrentUser.CreatedAt.ToString("dd MMM yyyy • HH:mm")
                                    </div>
                                </div>
                            </div>
                        }
                    </section>

                    <!-- Actions -->
                    <footer class="profile-actions">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-primary px-4"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editProfileModal">
                                <i class="bi bi-pencil me-2"></i>Edit Profile
                            </button>

                            <a asp-page="/Account/ChangePassword"
                               class="btn btn-outline-primary px-4">
                                <i class="bi bi-shield-lock me-2"></i>Change Password
                            </a>
                        </div>
                    </footer>
                </div>
            </article>
        </div>
    </div>
</div>

<!-- ================= MODAL ================= -->

<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold gradient-text">
                    <i class="bi bi-person-gear me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="editProfileForm" method="post" autocomplete="off">
                @Html.AntiForgeryToken()

                <div class="modal-body">
                    <!-- Avatar -->
                    <div class="text-center mb-4">
                        <div class="avatar-upload-container mx-auto" style="width:120px;">
                            <img id="avatarPreview"
                                 loading="lazy"
                                 class="rounded-circle border border-4 shadow"
                                 width="120"
                                 height="120"
                                 src="@(string.IsNullOrEmpty(Model.CurrentUser?.AvatarUrl)
                                                                         ? "/images/avatar-default.png"
                                                                         : Model.CurrentUser.AvatarUrl)" />

                            <label for="avatarFile" class="avatar-upload-btn">
                                <i class="bi bi-camera"></i>
                            </label>

                            <input id="avatarFile" type="file" class="d-none" accept="image/*" />
                        </div>

                        <input type="hidden"
                               id="AvatarUrl"
                               name="EditProfile.AvatarUrl"
                               value="@Model.CurrentUser?.AvatarUrl" />

                        <small class="text-muted d-block mt-2">
                            Click camera icon to upload new photo
                        </small>
                    </div>

                    <!-- Fields -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Full Name</label>
                        <input class="form-control"
                               name="EditProfile.FullName"
                               value="@Model.CurrentUser?.FullName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Username</label>
                        <input class="form-control"
                               name="EditProfile.Username"
                               value="@Model.CurrentUser?.Username" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Email</label>
                        <input type="email"
                               class="form-control"
                               name="EditProfile.Email"
                               value="@Model.CurrentUser?.Email" />
                    </div>

                    @if (!string.IsNullOrEmpty(Model.CurrentUser?.JobTitle) || !string.IsNullOrEmpty(Model.CurrentUser?.Department))
                    {
                        <div class="row">
                            @if (!string.IsNullOrEmpty(Model.CurrentUser?.JobTitle))
                            {
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Job Title</label>
                                    <input class="form-control"
                                           name="EditProfile.JobTitle"
                                           value="@Model.CurrentUser.JobTitle" />
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(Model.CurrentUser?.Department))
                            {
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Department</label>
                                    <input class="form-control"
                                           name="EditProfile.Department"
                                           value="@Model.CurrentUser.Department" />
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
