@page
@model PROJECTHUB_ENTERPRISE.Pages.Projects.DetailsModel
@using PROJECTHUB_ENTERPRISE.ViewModels
@using PROJECTHUB_ENTERPRISE.Models
@using TaskStatusEnum = PROJECTHUB_ENTERPRISE.Models.TaskStatus

@{

}


@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="projectId" value="@Model.Project.ProjectId" />

<input type="hidden"
       name="__RequestVerificationToken"
       value="@Antiforgery.GetAndStoreTokens(HttpContext).RequestToken" />



<h2 class="fw-bold">@Model.Project.Name</h2>
<p class="text-muted">@Model.Project.Description</p>

@if (Model.Project.IsArchived)
{
    <span class="badge bg-secondary">Archived</span>
}
else
{
    <span class="badge bg-success">Active</span>
}


<div class="nav nav-tabs mt-4" id="projectTabs">
    <a class="nav-link active" data-tab="summary">Summary</a>

    <a class="nav-link" data-tab="members">Members</a>

    <a class="nav-link" data-tab="board">Board</a>

    <a class="nav-link" data-tab="wiki">Wiki</a>

    @if (Model.Project.CurrentUserRole == "Manager")
    {
        <a class="nav-link" data-tab="settings">Settings</a>
    }
</div>
<div id="tab-summary" class="tab-content mt-4">

    <!-- STAT CARDS -->
    <div class="row">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6>Total Tasks</h6>
                    <h3 id="totalTasks">@Model.Project.TotalTasks</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6>Open</h6>
                    <h3 id="openTasks">@Model.Project.OpenTasks</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6>Completed</h6>
                    <h3 id="completedTasks">@Model.Project.CompletedTasks</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="row mt-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-semibold mb-3">Task status</h6>
                    <canvas id="taskStatusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-semibold mb-3">Tasks over time</h6>
                    <canvas id="taskLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="tab-members" class="tab-content mt-4 d-none">
<div class="card mt-5">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">Members</h5>

        @if (Model.Project.CurrentUserRole == "Manager")
        {
            <button class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#addMemberModal">
                + Add member
            </button>
        }
    </div>

    <ul class="list-group list-group-flush">
        @foreach (var m in Model.Project.Members)
        {
            <li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">

                    <!-- Avatar placeholder -->
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                         style="width:40px;height:40px;font-weight:600;">
                        @m.FullName.Substring(0, 1)
                    </div>

                    <div>
                        <div class="fw-semibold">@m.FullName</div>
                        <small class="text-muted">@m.Email</small>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <span class="badge @(m.Role == "Manager" ? "bg-primary" : "bg-secondary")">
                        @m.Role
                    </span>

                    @if (Model.Project.CurrentUserRole == "Manager" && m.Role != "Manager")
                    {
                        <form method="post"
                              asp-page-handler="RemoveMember"
                              asp-route-projectId="@Model.Project.ProjectId"
                              asp-route-userId="@m.UserId"
                              onsubmit="return confirm('Remove this member?')">
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="openRemoveModal(
                    '@Model.Project.ProjectId',
                    '@m.UserId',
                    '@m.FullName')">
                                    Remove
                                </button>


                        </form>
                    }
                </div>
            </li>
        }
    </ul>
</div>


<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <label class="form-label fw-semibold">Email</label>
                <input type="email"
                       id="memberEmail"
                       class="form-control"
                       placeholder="Enter email address"
                       autocomplete="off" />

                <!-- SEARCH RESULT -->
                <ul class="list-group mt-2 d-none"
                    id="userSearchResult">
                </ul>

                <!-- SELECTED USER -->
                <div id="selectedUser"
                     class="alert alert-light mt-3 d-none">
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-light"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                <button class="btn btn-primary"
                        id="addMemberBtn"
                        disabled>
                    Add
                </button>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="confirmRemoveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold text-danger">
                    Remove member
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to remove
                <strong id="removeMemberName"></strong>
                from this project?
            </div>

            <div class="modal-footer">
                <button class="btn btn-light"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                
            </div>

        </div>
    </div>
</div>
</div>
<div id="task-board">
    <div id="tab-board" class="tab-content mt-4 d-none">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">Task board</h5>

            <button class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#addTaskModal">
                + Add task
            </button>
        </div>

        <div class="d-flex flex-column gap-2">

            @foreach (var t in Model.Board.Todo
                        .Concat(Model.Board.InProgress)
                        .Concat(Model.Board.Review)
                        .Concat(Model.Board.Done)
                        .OrderBy(t => t.Deadline))
            {
                <div class="task-wrapper" data-task-id="@t.Id">

                    <!-- TASK HEADER -->
                    <div class="task-card d-flex align-items-center justify-content-between px-3 py-2 rounded task-header"
                         data-task-id="@t.Id"
                         style="background:#e0e0e0; cursor:pointer">

                        <!-- LEFT -->
                        <div>
                            <div class="fw-bold">
                                @t.Title
                                @if (t.Deadline.HasValue)
                                {
                                    <span class="text-muted">
                                        - @t.Deadline.Value.ToString("dd/MM/yyyy")
                                    </span>
                                }
                        </div>
                        <small>@t.AssigneeName</small>
                    </div>

                    <!-- RIGHT -->
                    <div class="d-flex gap-2">

                        <!-- STATUS -->
                        <div class="dropdown">
                            <button class="btn btn-sm fw-semibold dropdown-toggle
@(t.Status == TaskStatusEnum.Completed ? "btn-success" :
                                                                      t.Status == TaskStatusEnum.InProgress ? "btn-warning text-dark" :
                                                                      t.Status == TaskStatusEnum.Review ? "btn-danger" :
                                                                      "btn-secondary")"
                                    data-bs-toggle="dropdown">
                                @t.Status
                            </button>


                                <ul class="dropdown-menu" onclick="arguments[0].stopPropagation()">

                                    <li>
                                        <button class="dropdown-item"
                                                onclick="changeTaskStatus('@t.Id', 0)">
                                            Todo
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item"
                                                onclick="changeTaskStatus('@t.Id', 1)">
                                            In Progress
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item"
                                                onclick="changeTaskStatus('@t.Id', 2)">
                                            Review
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item"
                                                onclick="changeTaskStatus('@t.Id', 3)">
                                            Completed
                                        </button>
                                    </li>
                                </ul>
                            </div>

                        @if (Model.Project.CurrentUserRole == "Manager")
                            {
                                <div class="dropdown">
                                    <button class="btn btn-sm"
                                            data-bs-toggle="dropdown"
                                           >
                                        ⋯
                                    </button>

                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="openEditTask(
                                                        '@t.Id',
                                                        '@t.Title',
                                                        '@t.AssigneeId',
                                                        '@t.Deadline?.ToString("yyyy-MM-dd")',
                                                        '@((int)t.Status)')">
                                                Edit
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item text-danger"
                                                    onclick="deleteTask('@t.Id')">
                                                Delete
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                    <!-- 🔽 TASK DETAIL -->
                    <div class="collapse task-detail mt-1" id="task-detail-@t.Id">
                        <div class="card card-body">

                            <!-- COMMENT LIST -->
                            <div class="comments" data-task-id="@t.Id">
                                <div class="comment-list mb-2"></div>

                                <!-- REPLY INFO -->
                                <div class="reply-info small text-muted d-none mb-1"></div>

                                <!-- COMMENT INPUT -->
                                <textarea class="form-control form-control-sm comment-input"
                                      rows="2"
                                      placeholder="Write a comment..."
                                      data-task-id="@t.Id"></textarea>

                                <!-- 🔽 ATTACH FILE -->
                                <input type="file"
                                       name="Attachments"
                                       class="form-control form-control-sm mt-1 comment-attachments"
                                       data-task-id="@t.Id"
                                       multiple />

                                <div class="mt-1 d-flex gap-2">
                                    <button class="btn btn-sm btn-primary"
                                            onclick="postComment('@t.Id')">
                                        Send
                                    </button>

                                    <button class="btn btn-sm btn-outline-secondary d-none cancel-reply"
                                            onclick="cancelReply('@t.Id')">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>


                </div>
            }

        </div>
    </div>

</div>

<div id="tab-wiki" class="tab-content mt-4 d-none">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">📘 Project Wiki</h5>

        @if (Model.Project.CanEditWiki)
        {
            <button class="btn btn-sm btn-primary"
                    onclick="openCreateWiki('@Model.Project.ProjectId')">
                + New page
            </button>
        }
    </div>

    @if (!Model.Project.Wikis.Any())
    {
        <div class="text-muted fst-italic">
            Chưa có trang Wiki nào.
        </div>
    }
    else
    {
        <ul class="list-group">
            @foreach (var w in Model.Project.Wikis)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">

                    <span style="cursor:pointer"
                          onclick="openWikiDetail('@w.Id')">
                        📄 <strong>@w.Title</strong>
                    </span>

                    @if (Model.Project.CanEditWiki)
                    {
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary"
                                    onclick="event.stopPropagation(); openWikiDetail('@w.Id')">
                                View
                            </button>

                            <button class="btn btn-outline-danger"
                                    onclick="event.stopPropagation(); deleteWiki('@w.Id')">
                                Delete
                            </button>
                        </div>
                    }
                </li>
            }
        </ul>
    }
</div>

<div id="tab-settings" class="tab-content mt-4 d-none">

    <!-- PROJECT INFO -->
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            Project information
        </div>
        <div class="card-body">
            <div class="mb-2">
                <strong>Name:</strong> @Model.Project.Name
            </div>
            <div class="mb-2">
                <strong>Description:</strong> @Model.Project.Description
            </div>
            <div class="mb-2">
                <strong>Status:</strong>
                <span class="badge @(Model.Project.IsArchived ? "bg-secondary" : "bg-success")">
                    @(Model.Project.IsArchived ? "Archived" : "Active")
                </span>
            </div>
        </div>
    </div>

    <!-- OWNER -->
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            Project owner
        </div>
        <div class="card-body">
            <div><strong>@Model.Project.Owner.FullName</strong></div>
            <div class="text-muted">@Model.Project.Owner.Email</div>
        </div>
    </div>

    <!-- MEMBERS -->
    <div class="card mb-4">
        <div class="card-header fw-semibold">
            Members (@Model.Project.Members.Count)
        </div>
        <ul class="list-group list-group-flush">
            @foreach (var m in Model.Project.Members)
            {
                <li class="list-group-item d-flex justify-content-between">
                    <div>
                        <strong>@m.FullName</strong>
                        <div class="text-muted small">@m.Email</div>
                    </div>
                    <span class="badge bg-secondary">@m.Role</span>
                </li>
            }
        </ul>
    </div>

    <!-- DANGER ZONE -->
    @if (Model.Project.CanEditSettings)
    {
        <div class="card border-danger">
            <div class="card-header bg-danger text-white fw-semibold">
                Danger zone
            </div>
            <div class="card-body">
                <p class="text-danger mb-3">
                    This action will permanently delete this project and all related data.
                </p>
                <button class="btn btn-danger"
                        onclick="confirmDeleteProject()">
                    Delete project permanently
                </button>
            </div>
        </div>
    }
</div>

<!-- Pop up add task -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">Create task</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden"
                       id="taskProjectId"
                       value="@Model.Project.ProjectId" />

                <label class="form-label">Title</label>
                <input class="form-control"
                       id="taskTitle"
                       placeholder="Task title" />

                <label class="form-label mt-3">Assign to</label>
                <select class="form-select" id="taskAssignee">
                    <option value="">Unassigned</option>
                    @foreach (var m in Model.Project.Members)
                    {
                        <option value="@m.UserId">@m.FullName</option>
                    }
                </select>

                <label class="form-label mt-3">Deadline</label>
                <input type="date"
                       class="form-control"
                       id="taskDeadline" />

            </div>

            <div class="modal-footer">
                <button class="btn btn-light"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                <button class="btn btn-primary"
                        id="createTaskBtn">
                    Create
                </button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">Edit task</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="editTaskId" />

                <label class="form-label fw-semibold">Title</label>
                <input class="form-control mb-3" id="editTaskTitle" />

                <label class="form-label fw-semibold">Assignee</label>
                <select class="form-select mb-3" id="editTaskAssignee">
                    <option value="">Unassigned</option>
                    @foreach (var m in Model.Project.Members)
                    {
                        <option value="@m.UserId">@m.FullName</option>
                    }
                </select>

                <label class="form-label fw-semibold">Deadline</label>
                <input type="date" class="form-control mb-3" id="editTaskDeadline" />

                <label class="form-label fw-semibold">Status</label>
                <select class="form-select" id="editTaskStatus">
                    <option value="0">Todo</option>
                    <option value="1">In Progress</option>
                    <option value="2">Review</option>
                    <option value="3">Completed</option>
                </select>

            </div>

            <div class="modal-footer">
                <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="saveTaskEdit()">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- Pop up add wiki -->
<div class="modal fade" id="wikiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="wikiModalTitle">Wiki</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="wikiId" />

                <div class="mb-3">
                    <label>Title</label>
                    <input class="form-control" id="wikiTitle" />
                </div>

                <div class="mb-3">
                    <label>Content</label>
                    <textarea class="form-control" id="wikiContent" rows="6"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveWiki()">Save</button>
            </div>

        </div>
    </div>
</div>
<!-- Mention Modal -->
<div class="modal fade" id="mentionModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Mention member</h6>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="list-group list-group-flush" id="mention-list"></ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/project-summary.js"></script>
    <script src="~/js/project-details.js"></script>
   
}